<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Status Report - NID Alphaville</title>
  <style>
    :root {
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --primary: #2563eb;
      --text-main: #1f2937;
      --border: #e5e7eb;
      --header-grad: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }

    body {
      background: var(--bg);
      color: var(--text-main);
      padding: 20px;
      /* Importante: Espa√ßo extra no final para o bot√£o n√£o tampar conte√∫do */
      padding-bottom: 100px; 
    }

    .container { max-width: 1600px; margin: 0 auto; }

    /* --- HEADER --- */
    .header {
      background: var(--header-grad);
      color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px;
    }
    .header h1 { font-size: 22px; margin: 0; font-weight: 700; }
    .header h2 { font-size: 13px; opacity: 0.9; font-weight: 400; margin-top: 4px; }
    .badge-date { background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }

    /* --- LAYOUT GRID (Gantt Esquerda / Info Direita) --- */
    .layout-grid {
      display: grid;
      grid-template-columns: 70% 28%; /* Gantt ocupa 70% */
      gap: 2%;
      align-items: start;
    }

    .card {
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      border: 1px solid var(--border);
      overflow: hidden;
      margin-bottom: 20px;
    }

    .card-header {
      padding: 15px 20px;
      background: #f9fafb;
      border-bottom: 1px solid var(--border);
      font-weight: 700;
      color: #374151;
      font-size: 14px;
      display: flex; align-items: center; gap: 8px;
    }

    /* --- GANTT CHART --- */
    .gantt-wrapper {
      padding: 0;
      min-height: 400px;
      display: flex;
      flex-direction: column;
    }

    .gantt-header-row {
      display: grid;
      grid-template-columns: 350px 1fr; /* Coluna fixa Nome */
      background: #f3f4f6;
      border-bottom: 1px solid #d1d5db;
      font-size: 11px;
      font-weight: 700;
      color: #4b5563;
      text-transform: uppercase;
    }
    .gh-cell { padding: 10px 15px; border-right: 1px solid #e5e7eb; }

    .gantt-body {
      max-height: 600px;
      overflow-y: auto;
    }

    .gantt-row {
      display: grid;
      grid-template-columns: 350px 1fr;
      border-bottom: 1px solid #f3f4f6;
      min-height: 45px;
      align-items: center;
      transition: background 0.2s;
    }
    .gantt-row:hover { background: #f9fafb; }

    .gc-name {
      padding: 0 15px;
      font-size: 12px;
      font-weight: 600;
      color: #1f2937;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border-right: 1px solid #f3f4f6;
    }

    .gc-timeline {
      position: relative;
      height: 45px;
      padding: 10px 0;
    }

    .g-bar {
      position: absolute;
      top: 12px; height: 20px;
      border-radius: 4px;
      background: #3b82f6;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex; align-items: center; justify-content: center;
      color: white; font-size: 10px; font-weight: 600;
      padding: 0 8px;
      white-space: nowrap; overflow: hidden;
      cursor: help;
    }

    /* Cores variadas para as barras */
    .clr-0 { background: #2563eb; }
    .clr-1 { background: #059669; }
    .clr-2 { background: #d97706; }
    .clr-3 { background: #7c3aed; }
    .clr-4 { background: #db2777; }

    /* --- INFO SIDEBAR --- */
    .info-content { padding: 20px; }
    .info-group { margin-bottom: 15px; }
    .info-label { font-size: 11px; color: #6b778c; font-weight: 700; margin-bottom: 4px; text-transform: uppercase; }
    .info-value { font-size: 14px; font-weight: 600; color: #111827; }
    .desc-box { font-size: 13px; line-height: 1.5; color: #4b5563; background: #f9fafb; padding: 10px; border-radius: 6px; border: 1px solid #eee; }

    /* --- BOT√ÉO FLUTUANTE (FAB) CORRIGIDO --- */
    .fab-wrapper {
      position: fixed;
      bottom: 25px;   /* Dist√¢ncia do fundo */
      right: 25px;    /* Dist√¢ncia da direita */
      z-index: 99999; /* Garante que fique acima de TUDO */
      display: flex;
      flex-direction: column-reverse;
      align-items: flex-end;
      gap: 15px;
    }

    .fab-main-btn {
      width: 60px; height: 60px;
      border-radius: 50%;
      background: #1e40af; /* Azul escuro */
      color: white;
      border: none;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      font-size: 24px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .fab-main-btn:hover { transform: scale(1.1); }
    .fab-main-btn.open { transform: rotate(45deg); background: #dc2626; }

    .fab-list {
      display: flex; flex-direction: column-reverse; gap: 12px;
      align-items: flex-end;
      margin-bottom: 5px;
      /* Escondido por padr√£o */
      opacity: 0; pointer-events: none; transform: translateY(20px);
      transition: all 0.3s ease;
    }
    .fab-wrapper.active .fab-list { opacity: 1; pointer-events: all; transform: translateY(0); }

    .fab-item {
      display: flex; align-items: center; gap: 10px;
      background: white; padding: 8px 16px; border-radius: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border: none; cursor: pointer;
      font-size: 13px; font-weight: 600; color: #374151;
      transition: transform 0.2s;
    }
    .fab-item:hover { transform: translateX(-5px); background: #f3f4f6; }
    .fab-item span { font-size: 16px; }

    /* --- MODAL --- */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6);
      z-index: 100000; display: none; align-items: center; justify-content: center;
      backdrop-filter: blur(3px);
    }
    .modal-box {
      background: white; width: 95%; max-width: 650px;
      border-radius: 12px; padding: 25px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-height: 90vh; overflow-y: auto;
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .modal-title { font-size: 18px; font-weight: 700; color: #111827; }
    .btn-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #9ca3af; }

    /* Forms */
    .form-label { display: block; font-size: 12px; font-weight: 700; margin-bottom: 5px; color: #4b5563; }
    .form-input { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; margin-bottom: 15px; }
    .btn-submit { width: 100%; padding: 12px; background: #2563eb; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
    .btn-submit:hover { background: #1d4ed8; }
    
    .tab-btn { padding: 8px 12px; background: #eee; border:none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; }
    .tab-btn.active { background: #2563eb; color: white; }
    
    .json-textarea {
      width: 100%; height: 100px; padding: 10px; 
      border: 1px solid #ccc; border-radius: 6px; 
      font-family: monospace; font-size: 11px;
      margin-bottom: 10px;
    }

    /* Responsivo */
    @media (max-width: 1000px) {
      .layout-grid { grid-template-columns: 1fr; }
    }
    @media print {
      .fab-wrapper, .modal-overlay { display: none !important; }
      body { padding: 0; background: white; }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <div>
      <h1 id="lbl-project-name">Vis√£o Geral do Projeto</h1>
      <h2 id="lbl-project-status">Aguardando importa√ß√£o de dados...</h2>
    </div>
    <div class="badge-date" id="lbl-date">--/--/----</div>
  </div>

  <div class="layout-grid">
    <div>
      <div class="card">
        <div class="card-header">
          <span>üìÖ Cronograma de √âpicos e Entregas</span>
        </div>
        <div class="gantt-wrapper">
          <div class="gantt-header-row">
            <div class="gh-cell">Nome da Atividade / √âpico</div>
            <div class="gh-cell" style="display:flex; justify-content:space-between;">
              <span id="gantt-start-label">-</span>
              <span id="gantt-end-label">-</span>
            </div>
          </div>
          <div class="gantt-body" id="gantt-container">
            <div style="padding:40px; text-align:center; color:#9ca3af;">
              <p style="margin-bottom:10px; font-size:24px;">üìÇ</p>
              Nenhum dado carregado.<br>Clique no bot√£o <strong>‚öôÔ∏è</strong> no canto inferior direito para configurar.
            </div>
          </div>
        </div>
      </div>
    </div>

    <div>
      <div class="card">
        <div class="card-header">üìä Detalhes</div>
        <div class="info-content">
          <div class="info-group">
            <div class="info-label">Descri√ß√£o</div>
            <div class="desc-box" id="lbl-desc">Utilize a importa√ß√£o via API ou JSON para popular este painel.</div>
          </div>
          <div class="info-group">
            <div class="info-label">In√≠cio Real</div>
            <div class="info-value" id="lbl-start">-</div>
          </div>
          <div class="info-group">
            <div class="info-label">Previs√£o Entrega</div>
            <div class="info-value" id="lbl-end">-</div>
          </div>
          <div class="info-group">
            <div class="info-label">Total de Atividades</div>
            <div class="info-value" id="lbl-count">0</div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">‚ö†Ô∏è Riscos</div>
        <ul id="risk-list" style="padding: 15px 30px; font-size:12px; color:#555;">
          <li>Aguardando dados...</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div class="fab-wrapper" id="fab-menu">
  <div class="fab-list">
    <button class="fab-item" onclick="window.print()">Exportar PDF <span>üñ®Ô∏è</span></button>
    <button class="fab-item" onclick="alert('Funcionalidade Excel em dev.')">Excel <span>üìÇ</span></button>
    <button class="fab-item" onclick="openModal()">Configurar API <span>‚ö°</span></button>
  </div>
  <button class="fab-main-btn" id="fab-trigger" title="Menu de A√ß√µes">‚öôÔ∏è</button>
</div>

<div class="modal-overlay" id="api-modal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title">Importar Dados (API/JSON)</div>
      <button class="btn-close" onclick="closeModal()">&times;</button>
    </div>

    <div style="margin-bottom:15px; display:flex; gap:10px;">
      <button class="tab-btn active" id="tab-auto" onclick="switchTab('auto')">Modo Autom√°tico</button>
      <button class="tab-btn" id="tab-manual" onclick="switchTab('manual')">Modo Manual (Colar JSON)</button>
    </div>

    <div id="view-auto">
      <div class="form-label">URL da API</div>
      <input type="text" class="form-input" id="api-url" value="https://apiteams.goobee.com.br/api/ExportarQuadroExcel?idQuadro=cddbdeab-e50c-4f40-d5c2-08dc62c6f4a9&token=39SB80HUu%2B4yWhtOjtux4rKs8DlpFyeR7d/QJ/2Q1%2BQ=">
      <button type="button" class="btn-submit" style="background:#4b5563; margin-bottom:15px;" onclick="fetchDataAuto()">üîç 1. Buscar Projetos na URL</button>
    </div>

    <div id="view-manual" style="display:none;">
      <div style="background:#fff7ed; padding:10px; border-radius:6px; font-size:11px; color:#c2410c; margin-bottom:10px; border:1px solid #ffedd5;">
        <strong>Solu√ß√£o de Erro:</strong> Se o modo autom√°tico der erro, abra o link da API no navegador, copie todo o texto e cole abaixo.
      </div>
      <div class="form-label">Cole o JSON aqui:</div>
      <textarea class="json-textarea" id="json-paste" placeholder='[{"projeto": "Exemplo", "epico": "Tarefa 1"...}]'></textarea>
      <button type="button" class="btn-submit" style="background:#d97706; margin-bottom:15px;" onclick="processManualJSON()">üîç 1. Processar JSON Colado</button>
    </div>

    <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">

    <div class="form-label">Mapeamento de Campos (Chaves do JSON)</div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
      <input type="text" class="form-input" id="k-proj" value="projeto" placeholder="Key: Projeto">
      <input type="text" class="form-input" id="k-epic" value="epico" placeholder="Key: Nome Tarefa">
      <input type="text" class="form-input" id="k-start" value="dataInicio" placeholder="Key: Inicio">
      <input type="text" class="form-input" id="k-end" value="dataEntregaPrevista" placeholder="Key: Fim">
    </div>

    <div class="form-label">Selecione o Projeto Encontrado:</div>
    <select class="form-input" id="project-select" disabled>
      <option value="">(Realize o passo 1 primeiro)</option>
    </select>

    <button class="btn-submit" onclick="confirmImport()">‚úÖ Importar e Gerar Gr√°fico</button>

  </div>
</div>

<script>
  let rawData = []; // Armazena os dados brutos

  document.addEventListener('DOMContentLoaded', () => {
    // Data atual
    document.getElementById('lbl-date').textContent = new Date().toLocaleDateString('pt-BR');

    // Bot√£o FAB
    const fabTrigger = document.getElementById('fab-trigger');
    const fabWrapper = document.getElementById('fab-menu');
    fabTrigger.addEventListener('click', () => {
      fabWrapper.classList.toggle('active');
      fabTrigger.classList.toggle('open');
      fabTrigger.textContent = fabWrapper.classList.contains('active') ? '√ó' : '‚öôÔ∏è';
    });
  });

  // --- FUN√á√ïES DE MODAL ---
  function openModal() {
    document.getElementById('api-modal').style.display = 'flex';
    document.getElementById('fab-menu').classList.remove('active');
    document.getElementById('fab-trigger').classList.remove('open');
    document.getElementById('fab-trigger').textContent = '‚öôÔ∏è';
  }
  function closeModal() {
    document.getElementById('api-modal').style.display = 'none';
  }
  function switchTab(mode) {
    document.getElementById('view-auto').style.display = mode === 'auto' ? 'block' : 'none';
    document.getElementById('view-manual').style.display = mode === 'manual' ? 'block' : 'none';
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-' + mode).classList.add('active');
  }

  // --- L√ìGICA DE DADOS ---

  // 1. Fetch Autom√°tico (Tenta Proxy)
  async function fetchDataAuto() {
    const url = document.getElementById('api-url').value;
    const btn = document.querySelector('#view-auto button');
    
    if(!url) return alert('Insira a URL');
    btn.textContent = 'Buscando...';

    try {
      // Tenta via Proxy AllOrigins para evitar CORS
      const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
      const resp = await fetch(proxyUrl);
      if(!resp.ok) throw new Error('Erro de Rede/CORS');
      
      const json = await resp.json();
      handleDataSuccess(json);

    } catch (err) {
      console.error(err);
      alert('ERRO: O navegador bloqueou o acesso √† API (CORS). \n\nSOLU√á√ÉO: Mude para a aba "Modo Manual", copie o JSON do link e cole na caixa de texto.');
      switchTab('manual');
    } finally {
      btn.textContent = 'üîç 1. Buscar Projetos na URL';
    }
  }

  // 2. Processar Manual
  function processManualJSON() {
    const text = document.getElementById('json-paste').value;
    try {
      const json = JSON.parse(text);
      handleDataSuccess(json);
    } catch (e) {
      alert('JSON Inv√°lido. Verifique se copiou corretamente.');
    }
  }

  // 3. Sucesso ao obter dados -> Popular Select
  function handleDataSuccess(json) {
    // Normalizar para array
    rawData = Array.isArray(json) ? json : (json.data || [json]);
    
    const keyProj = document.getElementById('k-proj').value;
    const select = document.getElementById('project-select');
    
    // Extrair projetos √∫nicos
    const projects = new Set();
    rawData.forEach(item => {
      if(item[keyProj]) projects.add(item[keyProj]);
    });

    select.innerHTML = '<option value="">-- Selecione um Projeto --</option>';
    if(projects.size === 0) {
      alert('Nenhum projeto encontrado com a chave "' + keyProj + '". Verifique os nomes das chaves.');
      return;
    }

    projects.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p;
      opt.textContent = p;
      select.appendChild(opt);
    });
    
    select.disabled = false;
    alert(`Sucesso! ${projects.size} projetos carregados na lista.`);
  }

  // 4. Importar Final -> Gerar Gr√°fico
  function confirmImport() {
    const selectedProj = document.getElementById('project-select').value;
    if(!selectedProj) return alert('Selecione um projeto da lista.');

    // Chaves
    const kProj = document.getElementById('k-proj').value;
    const kEpic = document.getElementById('k-epic').value;
    const kStart = document.getElementById('k-start').value;
    const kEnd = document.getElementById('k-end').value;

    // Filtrar e Mapear
    const tasks = rawData
      .filter(item => item[kProj] === selectedProj)
      .map(item => ({
        name: item[kEpic] || 'Sem Nome',
        start: item[kStart],
        end: item[kEnd]
      }))
      .filter(t => t.start); // Remove sem data

    if(tasks.length === 0) return alert('Nenhuma tarefa v√°lida encontrada para este projeto.');

    renderGantt(selectedProj, tasks);
    closeModal();
  }

  // --- RENDERIZADOR ---
  function renderGantt(projName, tasks) {
    // Labels
    document.getElementById('lbl-project-name').textContent = projName;
    document.getElementById('lbl-project-status').textContent = 'Status: Em andamento (Dados Importados)';
    document.getElementById('lbl-count').textContent = tasks.length;
    document.getElementById('lbl-desc').textContent = `Visualizando cronograma com ${tasks.length} itens importados.`;

    // Datas Min/Max
    let minDate = null, maxDate = null;
    tasks.forEach(t => {
      const s = new Date(t.start);
      const e = t.end ? new Date(t.end) : s;
      if(!isNaN(s) && (minDate === null || s < minDate)) minDate = s;
      if(!isNaN(e) && (maxDate === null || e > maxDate)) maxDate = e;
    });

    // Margem de seguran√ßa
    if(!minDate) minDate = new Date();
    if(!maxDate) maxDate = new Date();
    minDate = new Date(minDate.getTime() - (5 * 86400000));
    maxDate = new Date(maxDate.getTime() + (10 * 86400000));
    
    const totalTime = maxDate - minDate;

    // Atualiza Labels Info
    const fmt = d => d.toLocaleDateString('pt-BR');
    document.getElementById('lbl-start').textContent = fmt(minDate);
    document.getElementById('lbl-end').textContent = fmt(maxDate);
    document.getElementById('gantt-start-label').textContent = fmt(minDate);
    document.getElementById('gantt-end-label').textContent = fmt(maxDate);

    // Desenha Linhas
    const container = document.getElementById('gantt-container');
    container.innerHTML = '';

    tasks.forEach((t, i) => {
      const s = new Date(t.start);
      let e = t.end ? new Date(t.end) : s;
      
      if(isNaN(s.getTime())) return;

      // C√°lculos %
      let left = ((s - minDate) / totalTime) * 100;
      let width = ((e - s) / totalTime) * 100;
      if(left < 0) left = 0;
      if(width < 1) width = 1;

      const colorClass = `clr-${i % 5}`;

      const row = document.createElement('div');
      row.className = 'gantt-row';
      row.innerHTML = `
        <div class="gc-name" title="${t.name}">${t.name}</div>
        <div class="gc-timeline">
          <div class="g-bar ${colorClass}" style="left:${left}%; width:${width}%;" title="${t.name}: ${fmt(s)} - ${fmt(e)}">
            ${t.name}
          </div>
        </div>
      `;
      container.appendChild(row);
    });
    
    // Riscos Fake
    document.getElementById('risk-list').innerHTML = `
      <li>Verificar consist√™ncia das datas importadas.</li>
      <li>Confirmar aloca√ß√£o de recursos para os ${tasks.length} √©picos listados.</li>
    `;
  }
</script>

</body>
</html>
