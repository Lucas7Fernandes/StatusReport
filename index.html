<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Status Report - Projeto</title>
  <style>
    :root {
      --bg: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
      --card-bg: #ffffff;
      --primary: #0052cc;
      --text-main: #172b4d;
      --text-muted: #6b778c;
      --border: #dfe1e6;
      --green: #36b37e;
      --yellow: #ffab00;
      --red: #ff5630;
      --blue-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gray-chip: #a8b2c1;
      --shadow-sm: 0 2px 8px rgba(9, 30, 66, 0.08);
      --shadow-md: 0 8px 24px rgba(9, 30, 66, 0.15);
      --shadow-lg: 0 12px 32px rgba(9, 30, 66, 0.2);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    body { background: var(--bg); color: var(--text-main); padding: 12px 16px; line-height: 1.5; min-height: 100vh; font-size: 13px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 14px 16px; margin-bottom: 12px; box-shadow: var(--shadow-md); color: white; }
    .header-content { display: flex; justify-content: space-between; align-items: center; gap: 16px; }
    .header-left h1 { font-size: 18px; margin-bottom: 2px; font-weight: 700; letter-spacing: -0.3px; }
    .header-left h2 { font-size: 11px; font-weight: 400; opacity: 0.9; }
    .header-right { text-align: right; font-size: 11px; opacity: 0.95; background: rgba(255, 255, 255, 0.15); padding: 6px 10px; border-radius: 8px; backdrop-filter: blur(10px); }
    .header-right div:last-child { font-weight: 700; font-size: 12px; margin-top: 2px; }
    
    /* CORRE√á√ÉO 1: Layout com alinhamento vertical stretch */
    .layout { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: stretch; margin-bottom: 12px; }
    .layout > div { display: flex; flex-direction: column; gap: 10px; }
    .layout > div:first-child { display: flex; flex-direction: column; }
    .layout > div:first-child > .card { flex: 1; display: flex; flex-direction: column; }
    .layout > div:first-child > .card > .project-description { flex: 1; }
    
    .gantt-full-width { grid-column: 1 / -1; }
    .card { background: var(--card-bg); border-radius: 12px; padding: 12px 12px; box-shadow: var(--shadow-sm); margin-bottom: 0; border: 1px solid rgba(0, 0, 0, 0.04); transition: box-shadow 0.2s ease; }
    .card:hover { box-shadow: var(--shadow-md); }
    .section-title { font-size: 13px; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; color: var(--text-main); padding-bottom: 6px; border-bottom: 1px solid #f0f2f5; }
    .section-title .emoji { font-size: 16px; }
    .status-pill { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 999px; font-size: 11px; background: linear-gradient(135deg, #e6f4ff 0%, #d1e9ff 100%); color: #0060df; font-weight: 600; margin-bottom: 8px; box-shadow: 0 1px 4px rgba(0, 96, 223, 0.15); }
    .status-pill .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(0.9); } }
    .project-description { font-size: 12px; margin: 8px 0; line-height: 1.6; color: var(--text-main); white-space: pre-line; }
    .project-description .label { font-weight: 700; color: var(--primary); }
    .project-dates { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px; margin: 10px 0 6px; }
    .date-box { background: #f8f9fa; padding: 6px; border-radius: 6px; border-left: 3px solid var(--primary); }
    .date-box .label { font-weight: 600; color: var(--text-muted); font-size: 9px; text-transform: uppercase; letter-spacing: 0.4px; margin-bottom: 2px; display: block; }
    .date-box .value { font-weight: 700; font-size: 12px; color: var(--text-main); }
    .progress-wrapper { margin-top: auto; padding-top: 10px; }
    .progress-label { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-main); margin-bottom: 4px; font-weight: 600; }
    .progress-label .percentage { color: var(--primary); font-size: 14px; font-weight: 700; }
    .progress-bar { width: 100%; height: 8px; border-radius: 999px; background: #e9ecef; overflow: hidden; position: relative; }
    .progress-bar-inner { height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary) 0%, #0066ff 100%); border-radius: 999px; transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 8px rgba(0, 82, 204, 0.3); position: relative; overflow: hidden; }
    .progress-bar-inner::after { content: ''; position: absolute; top: 0; left: 0; bottom: 0; right: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.35), transparent); animation: shimmer 1.8s infinite; }
    @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
    table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 11px; margin-top: 4px; overflow: hidden; border-radius: 6px; }
    th, td { padding: 6px 8px; text-align: left; border-bottom: 1px solid var(--border); }
    th { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); font-weight: 700; color: var(--text-main); font-size: 10px; text-transform: uppercase; letter-spacing: 0.4px; }
    tbody tr { transition: background 0.2s ease; }
    tbody tr:last-child td { border-bottom: none; }
    .badge { display: inline-flex; align-items: center; gap: 4px; font-size: 10px; padding: 2px 8px; border-radius: 999px; background: #f4f5f7; font-weight: 600; }
    .badge .status-dot { width: 6px; height: 6px; border-radius: 50%; }
    .badge.red { background: rgba(255, 86, 48, 0.1); color: var(--red); }
    .badge.red .status-dot { background: var(--red); }
    .badge.yellow { background: rgba(255, 171, 0, 0.1); color: #d97706; }
    .badge.yellow .status-dot { background: var(--yellow); }
    .badge.green { background: rgba(54, 179, 126, 0.1); color: var(--green); }
    .badge.green .status-dot { background: var(--green); }
    ul { margin-left: 0; padding-left: 0; list-style: none; font-size: 11px; color: var(--text-main); }
    ul li { margin-bottom: 6px; padding-left: 16px; position: relative; line-height: 1.4; }
    ul li::before { content: '‚ñ∏'; position: absolute; left: 0; color: var(--red); font-weight: bold; font-size: 12px; }
    ul li strong { color: var(--text-main); }
    .gantt-section { background: white; border-radius: 12px; overflow: hidden; box-shadow: var(--shadow-sm); border: 1px solid rgba(0, 0, 0, 0.04); }
    .gantt-wrapper { overflow-x: auto; overflow-y: visible; }
    .gantt-container { min-width: 100%; width: max-content; }
    .gantt-header { display: grid; grid-template-columns: 280px minmax(600px, 1fr); background: var(--blue-gradient); color: white; }
    .gantt-header-left { padding: 8px 10px; font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; font-weight: 700; display: flex; align-items: center; position: sticky; left: 0; background: inherit; z-index: 2; }
    .gantt-header-right { display: flex; min-width: 600px; }
    .gantt-header-month { flex: 1; min-width: 70px; padding: 8px 4px; text-align: center; font-size: 10px; text-transform: uppercase; letter-spacing: 0.6px; font-weight: 700; border-left: 1px solid rgba(255, 255, 255, 0.15); white-space: nowrap; }
    .gantt-header-month:first-child { border-left: none; }
    .gantt-grid { background: white; }
    .gantt-row { display: grid; grid-template-columns: 280px minmax(600px, 1fr); align-items: stretch; min-height: 48px; border-top: 1px solid #f0f2f6; }
    .gantt-row.historia-row { min-height: 36px; background: #fafbfc; display: none; }
    .gantt-row.historia-row.expanded { display: grid; }
    .gantt-row:first-child { border-top: none; }
    .gantt-row-left { padding: 8px 10px; display: flex; flex-direction: column; gap: 4px; position: sticky; left: 0; background: white; z-index: 1; border-right: 1px solid #f0f2f6; }
    .gantt-row.historia-row .gantt-row-left { padding-left: 24px; background: #fafbfc; }
    .process-title { font-size: 12px; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 6px; }
    .expand-toggle { cursor: pointer; font-size: 10px; color: var(--text-muted); padding: 2px 6px; border-radius: 4px; background: #f1f3f5; border: 1px solid #dee2e6; transition: all 0.2s ease; user-select: none; flex-shrink: 0; }
    .expand-toggle:hover { background: #e9ecef; color: var(--text-main); }
    .expand-toggle.has-historias { color: var(--primary); border-color: var(--primary); }
    .historia-count { font-size: 10px; color: var(--text-muted); background: #f8f9fa; padding: 2px 6px; border-radius: 999px; font-weight: 600; }
    .historia-row .process-title { font-size: 11px; font-weight: 600; color: var(--text-muted); }
    .historia-row .process-title::before { content: '‚îî '; color: #cbd5e1; margin-right: 4px; }
    .process-date { font-size: 10px; color: var(--text-muted); font-weight: 500; }
    .gantt-row-right { padding: 8px 10px; position: relative; min-width: 600px; }
    .gantt-lane { position: relative; width: 100%; height: 22px; background: #f8f9fa; border-radius: 999px; overflow: hidden; }
    .gantt-bar { position: absolute; height: 18px; border-radius: 999px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; font-weight: 700; box-shadow: var(--shadow-sm); white-space: nowrap; padding: 0 10px; top: 2px; transition: all 0.2s ease; }
    .status-chip { display: inline-flex; align-items: center; justify-content: center; padding: 2px 8px; border-radius: 999px; font-size: 9px; font-weight: 700; color: white; text-transform: uppercase; letter-spacing: 0.4px; }
    .status-concluido { background: linear-gradient(135deg, #36b37e 0%, #2d9f6f 100%); }
    .status-em-andamento { background: var(--blue-gradient); }
    .status-aguardando { background: linear-gradient(135deg, var(--gray-chip) 0%, #909dad 100%); }
    .cronograma-print-table { display: none; }
    .floating-edit-button { position: fixed; bottom: 64px; right: 20px; padding: 8px 18px; border-radius: 999px; border: none; background: #0f766e; color: #ffffff; font-weight: 600; font-size: 12px; box-shadow: var(--shadow-md); cursor: pointer; z-index: 1000; }
    .floating-update-button { position: fixed; bottom: 24px; right: 20px; padding: 8px 18px; border-radius: 999px; border: none; background-image: var(--blue-gradient); color: #ffffff; font-weight: 600; font-size: 12px; box-shadow: var(--shadow-md); cursor: pointer; z-index: 1000; }
    .alert-box { background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 12px; margin: 10px 0; font-size: 12px; color: #856404; }
    .alert-box strong { display: block; margin-bottom: 4px; }
    
    /* CORRE√á√ÉO 2: Estilos para bot√µes de expandir/colapsar todos */
    .gantt-controls { display: flex; gap: 8px; padding: 8px 12px; background: #f8f9fa; border-bottom: 1px solid #e9ecef; flex-wrap: wrap; }
    .gantt-control-btn { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 6px; border: 1px solid #dee2e6; background: white; color: var(--text-main); font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
    .gantt-control-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
    .gantt-control-btn svg { width: 14px; height: 14px; }
    
    .editor-backdrop { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.45); display: none; align-items: center; justify-content: center; z-index: 1100; }
    .editor-panel { background: #ffffff; border-radius: 12px; box-shadow: var(--shadow-lg); max-width: 960px; width: 95%; max-height: 90vh; display: flex; flex-direction: column; padding: 16px 18px; }
    .editor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .editor-header h3 { font-size: 14px; font-weight: 700; }
    .editor-close-btn { border: none; background: transparent; font-size: 18px; cursor: pointer; line-height: 1; }
    .editor-tabs { display: flex; gap: 6px; margin-bottom: 8px; flex-wrap: wrap; }
    .editor-tabs button { border: none; border-radius: 999px; padding: 4px 10px; font-size: 11px; cursor: pointer; background: #f3f4f6; color: #4b5563; font-weight: 600; }
    .editor-tabs button.active { background: #0f766e; color: #ffffff; }
    .editor-content { flex: 1; overflow: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px; background: #f9fafb; margin-bottom: 10px; }
    .editor-tab { display: none; }
    .editor-tab.active { display: block; }
    .editor-table { width: 100%; border-collapse: collapse; font-size: 11px; }
    .editor-table th, .editor-table td { border-bottom: 1px solid #e5e7eb; padding: 4px 6px; text-align: left; }
    .editor-table th { background: #eef2ff; font-weight: 600; text-transform: uppercase; font-size: 10px; letter-spacing: 0.4px; }
    .editor-table input, .editor-table textarea { width: 100%; font-size: 11px; padding: 3px 4px; border-radius: 4px; border: 1px solid #d1d5db; font-family: inherit; }
    .editor-table textarea { min-height: 60px; resize: vertical; }
    .editor-footer { display: flex; justify-content: flex-end; gap: 8px; }
    .editor-footer button { border-radius: 999px; border: none; padding: 6px 14px; font-size: 11px; font-weight: 600; cursor: pointer; }
    .editor-footer .cancel-btn { background: #e5e7eb; color: #374151; }
    .editor-footer .save-btn { background: #0f766e; color: #ffffff; }
    .editor-add-btn { margin-top: 6px; padding: 4px 10px; font-size: 11px; border-radius: 999px; border: 1px solid #cbd5e1; background: #f8fafc; cursor: pointer; }
    .row-delete-btn { padding: 2px 8px; font-size: 10px; border-radius: 999px; border: 1px solid #fecaca; background: #fee2e2; color: #b91c1c; cursor: pointer; white-space: nowrap; }
    @media (max-width: 1024px) { .layout { grid-template-columns: 1fr; } .header-content { flex-direction: column; align-items: flex-start; } .header-right { text-align: left; } }
    @media (max-width: 768px) { body { padding: 10px; } .header { padding: 10px 12px; } .header-left h1 { font-size: 16px; } .project-dates { grid-template-columns: 1fr; } .gantt-header, .gantt-row { grid-template-columns: 1fr; } .gantt-row-right { border-left: none; border-top: 1px solid #f0f2f6; } }
    @page { size: A4 portrait; margin: 5mm; }
    @media print { body { background: #ffffff !important; padding: 0 !important; font-size: 10px; } .container { max-width: 100% !important; margin: 0 !important; padding: 0 4mm !important; } .floating-update-button, .floating-edit-button, #excel-file, .alert-box, .gantt-controls { display: none !important; } .gantt-section { display: none !important; } .cronograma-print-table { display: block !important; } .cronograma-print-table table { font-size: 9px; } .cronograma-print-table th, .cronograma-print-table td { padding: 3px 4px; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-content">
        <div class="header-left">
          <h1 id="project-name">Carregue a planilha do sistema</h1>
          <h2>Relat√≥rio de Status do Projeto</h2>
        </div>
        <div class="header-right">
          <div>üìÖ Data do relat√≥rio</div>
          <div><span id="report-date"></span></div>
        </div>
      </div>
    </div>
    <div id="validation-alerts"></div>
    <div class="layout">
      <div>
        <div class="card">
          <div class="section-title"><span class="emoji">üéØ</span><span>Resumo Executivo</span></div>
          <div class="status-pill"><span class="status-dot" id="status-geral-dot"></span><span id="status-geral-text">Aguardando importa√ß√£o...</span></div>
          <div class="project-description"><span class="label">Descri√ß√£o do Projeto:</span><br><span id="project-description-text">Clique em "Atualizar" e carregue a planilha extra√≠da do sistema.</span></div>
          <div class="project-dates">
            <div class="date-box"><span class="label">Data de In√≠cio</span><span class="value" id="project-start-date">--/--/----</span></div>
            <div class="date-box"><span class="label">Previs√£o de Conclus√£o</span><span class="value" id="project-end-date">--/--/----</span></div>
          </div>
          <div class="progress-wrapper">
            <div class="progress-label"><span>Progresso Geral do Projeto</span><span class="percentage" id="project-progress-percent">0%</span></div>
            <div class="progress-bar"><div class="progress-bar-inner" id="progress"></div></div>
          </div>
        </div>
      </div>
      <div>
        <div class="card">
          <div class="section-title"><span class="emoji">üìà</span><span>Marcos Principais</span></div>
          <table><thead><tr><th>Data</th><th>Marco</th><th>Status</th></tr></thead><tbody id="marcos-body"><tr><td colspan="3" style="text-align: center; color: #6b778c;">Aguardando dados...</td></tr></tbody></table>
        </div>
        <div class="card">
          <div class="section-title"><span class="emoji">‚ö†Ô∏è</span><span>Riscos e Pend√™ncias Cr√≠ticas</span></div>
          <ul id="risk-list"><li>Aguardando dados...</li></ul>
        </div>
        <div class="card">
          <div class="section-title"><span class="emoji">‚û°Ô∏è</span><span>Pr√≥ximos Passos</span></div>
          <table><thead><tr><th>Atividade</th><th>Data Prevista</th><th>Respons√°vel</th></tr></thead><tbody id="next-steps-body"><tr><td colspan="3" style="text-align: center; color: #6b778c;">Aguardando dados...</td></tr></tbody></table>
        </div>
      </div>
    </div>
    <div class="card gantt-full-width" style="padding: 10px 10px 8px; overflow: hidden;">
      <div class="section-title" style="border: none; margin-bottom: 6px; padding-bottom: 0;"><span class="emoji">üìã</span><span>Cronograma Macro (Gantt)</span></div>
      <div class="gantt-section">
        <!-- CORRE√á√ÉO 2: Bot√µes de Expandir/Colapsar Todos -->
        <div class="gantt-controls">
          <button type="button" class="gantt-control-btn" id="btn-expand-all">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            Expandir Todos
          </button>
          <button type="button" class="gantt-control-btn" id="btn-collapse-all">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            Colapsar Todos
          </button>
        </div>
        <div class="gantt-wrapper">
          <div class="gantt-container">
            <div class="gantt-header">
              <div class="gantt-header-left">√âPICO/HIST√ìRIA</div>
              <div class="gantt-header-right" id="gantt-header-months"><div class="gantt-header-month">--</div></div>
            </div>
            <div class="gantt-grid" id="gantt-grid"><div style="padding: 20px; text-align: center; color: #6b778c;">Aguardando dados...</div></div>
          </div>
        </div>
      </div>
      <div class="cronograma-print-table"><table><thead><tr><th>√âpico/Hist√≥ria</th><th>Per√≠odo</th><th>Status</th><th>%</th></tr></thead><tbody id="gantt-print-body"></tbody></table></div>
    </div>
  </div>
  <button class="floating-edit-button" id="edit-button">‚úèÔ∏è Editar</button>
  <button class="floating-update-button" id="update-button">üì• Atualizar</button>
  <input type="file" id="excel-file" accept=".xlsx,.xls" style="display:none" />
  <div class="editor-backdrop" id="editor-modal">
    <div class="editor-panel">
      <div class="editor-header"><h3>Editar dados do projeto</h3><button type="button" class="editor-close-btn" id="editor-close">&times;</button></div>
      <div class="editor-tabs">
        <button type="button" data-tab="meta" class="active">Dados gerais</button>
        <button type="button" data-tab="processos">Cronograma</button>
        <button type="button" data-tab="marcos">Marcos</button>
        <button type="button" data-tab="riscos">Riscos</button>
        <button type="button" data-tab="proximos">Pr√≥ximos passos</button>
      </div>
      <div class="editor-content">
        <div class="editor-tab active" id="editor-tab-meta" data-tab="meta"></div>
        <div class="editor-tab" id="editor-tab-processos" data-tab="processos"></div>
        <div class="editor-tab" id="editor-tab-marcos" data-tab="marcos"></div>
        <div class="editor-tab" id="editor-tab-riscos" data-tab="riscos"></div>
        <div class="editor-tab" id="editor-tab-proximos" data-tab="proximos"></div>
      </div>
      <div class="editor-footer">
        <button type="button" class="cancel-btn" id="editor-cancel">Cancelar</button>
        <button type="button" class="save-btn" id="editor-save">Salvar altera√ß√µes</button>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    document.getElementById('report-date').textContent = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
    let currentData = null;

    function toDate(value) {
      if (!value) return null;
      if (value instanceof Date) return value;
      if (typeof value === 'number' && window.XLSX && XLSX.SSF && XLSX.SSF.parse_date_code) {
        const o = XLSX.SSF.parse_date_code(value);
        if (o) return new Date(o.y, o.m - 1, o.d);
      }
      if (typeof value === 'string') {
        const str = value.trim();
        if (!str) return null;
        let m = str.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (m) return new Date(parseInt(m[1], 10), parseInt(m[2], 10) - 1, parseInt(m[3], 10));
        m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
        if (m) return new Date(parseInt(m[3], 10), parseInt(m[2], 10) - 1, parseInt(m[1], 10));
        const parsed = new Date(str);
        if (!isNaN(parsed.getTime())) return parsed;
      }
      return null;
    }

    function formatDate(value) {
      const d = toDate(value);
      if (!d) return value ? String(value) : '';
      return d.toLocaleDateString('pt-BR');
    }

    function cleanPercentage(value) {
      if (!value) return 0;
      return Number(String(value).replace('%', '').trim()) || 0;
    }

    function formatDescription(desc) {
      if (!desc) return '';
      let text = String(desc), result = '';
      const descMatch = text.match(/DESCRI√á√ÉO:\s*\[\s*([\s\S]*?)\s*\]\s*(?:GANHOS:|$)/i);
      if (descMatch) result = descMatch[1].trim();
      const ganhosMatch = text.match(/GANHOS:\s*\[\s*([\s\S]*?)\s*\]\s*(?:%SEMANA|$)/i);
      if (ganhosMatch && ganhosMatch[1].trim()) {
        if (result) result += '\n\n';
        result += 'Ganhos do Projeto:\n' + ganhosMatch[1].trim();
      }
      if (!result) result = text.replace(/\[DESCRI√á√ÉO:\s*/gi, '').replace(/\[GANHOS:\s*/gi, '').replace(/\[%SEMANA ANTERIOR:.*?\]/gi, '').replace(/\]/g, '').trim();
      return result;
    }

    function mapSemaphoreColor(sem) {
      if (!sem) return 'verde';
      const v = String(sem).toLowerCase();
      if (v.includes('verm') || v.includes('red')) return 'vermelho';
      if (v.includes('amar') || v.includes('yellow')) return 'amarelo';
      return 'verde';
    }

    function mapStatusFromMomento(momento) {
      if (!momento) return 'Aguardando';
      const m = String(momento).toUpperCase();
      if (m.includes('FINALIZADO')) return 'Conclu√≠do';
      if (m.includes('EM ANDAMENTO') || m.includes('EMANDAMENTO')) return 'Em andamento';
      if (m.includes('BLOQUEADO')) return 'Bloqueado';
      return 'Aguardando';
    }

    function mapColorClass(cor) {
      if (!cor) return 'green';
      const v = String(cor).toLowerCase();
      if (v.includes('verm') || v.includes('red')) return 'red';
      if (v.includes('amar') || v.includes('yellow')) return 'yellow';
      return 'green';
    }

    function mapStatusChipClass(status) {
      const s = (status || '').toString().toLowerCase();
      if (s.includes('aguard') || s.includes('backlog') || s.includes('bloqueado')) return 'status-aguardando';
      if (s.includes('andamento')) return 'status-em-andamento';
      return 'status-concluido';
    }

    function removeNumericPrefix(name) {
      if (!name) return '';
      return String(name).replace(/^\d{3}\|/, '').trim();
    }

    function parseSistemaExcel(workbook) {
      const data = { meta: {}, epicos: [], itens: [], processos: [], marcos: [], riscos: [], proximos: [], warnings: [] };
      
      const dadosSheet = workbook.Sheets['Dados do projeto'];
      if (dadosSheet) {
        const rows = XLSX.utils.sheet_to_json(dadosSheet, { header: 1, raw: true });
        if (rows && rows.length > 0) {
          const headers = rows[0], values = rows[1] || [];
          const idx = (field) => headers.findIndex(h => h && String(h).includes(field));
          data.meta.NomeProjeto = values[idx('Nome')] || '';
          data.meta.DescricaoProjeto = formatDescription(values[idx('Descri√ß√£o')]);
          data.meta.ProgressoGeralPercentual = cleanPercentage(values[idx('Percentual Projeto')]);
          data.meta.CorStatusGeral = mapSemaphoreColor(values[idx('Sem√°foro')]);
          data.meta.StatusGeral = values[idx('Status do projeto')] || '';
          data.meta.DataInicio = values[idx('Data de in√≠cio prevista')] || '';
          data.meta.DataFimPrevista = values[idx('Data de t√©rmino prevista')] || '';
          data.meta.Responsavel = values[idx('Respons√°vel')] || '';
          data.meta.Owner = values[idx('Owner')] || '';
        }
      } else { data.warnings.push('Aba "Dados do projeto" n√£o encontrada'); }

      const epicosSheet = workbook.Sheets['√âpicos'];
      if (epicosSheet) {
        const rows = XLSX.utils.sheet_to_json(epicosSheet, { header: 1, raw: true });
        if (rows && rows.length > 1) {
          const headers = rows[0];
          const idx = (field) => headers.findIndex(h => h && String(h).includes(field));
          for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            if (!row || !row[idx('Nome')]) continue;
            data.epicos.push({
              nome: removeNumericPrefix(row[idx('Nome')]),
              nomeOriginal: row[idx('Nome')],
              progresso: cleanPercentage(row[idx('Progresso')]),
              status: row[idx('Status')] || '',
              dataInicio: row[idx('Data de in√≠cio')] || null,
              dataFim: row[idx('Data prevista de entrega')] || null,
              responsavel: row[idx('Respons√°vel')] || ''
            });
          }
        }
      } else { data.warnings.push('Aba "√âpicos" n√£o encontrada'); }

      const itensSheet = workbook.Sheets['Itens do projeto'];
      if (itensSheet) {
        const rows = XLSX.utils.sheet_to_json(itensSheet, { header: 1, raw: true });
        if (rows && rows.length > 1) {
          const headers = rows[0];
          const idx = (field) => headers.findIndex(h => h && String(h).includes(field));
          const dataInicioIdx = idx('Data de In√≠cio') >= 0 ? idx('Data de In√≠cio') : idx('Data In√≠cio');
          for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            if (!row || !row[idx('Item')]) continue;
            data.itens.push({
              id: row[idx('Id')] || '',
              item: row[idx('Item')] || '',
              tipo: row[idx('Tipo')] || '',
              momento: row[idx('Momento')] || '',
              epico: row[idx('√âpico')] || '',
              dataInicio: row[dataInicioIdx] || null,
              dataPrevista: row[idx('Data Prevista')] || null,
              dataEntrega: row[idx('Data de Entrega')] || null,
              responsavel: row[idx('Respons√°vel')] || '',
              iteracao: row[idx('Itera√ß√£o')] || ''
            });
          }
        }
      } else { data.warnings.push('Aba "Itens do projeto" n√£o encontrada'); }

      processarDadosDerivados(data);
      return data;
    }

    function processarDadosDerivados(data) {
      data.epicos.forEach((epico, index) => {
        const itensDoEpico = data.itens.filter(item => item.epico && item.epico.includes(epico.nomeOriginal));
        let dataInicio = epico.dataInicio, dataFim = epico.dataFim, progresso = epico.progresso, status = epico.status;

        if (itensDoEpico.length > 0) {
          const datasInicio = itensDoEpico.map(i => i.dataInicio).filter(d => d).map(d => toDate(d)).filter(d => d);
          const datasEntrega = itensDoEpico.map(i => i.dataEntrega || i.dataPrevista).filter(d => d).map(d => toDate(d)).filter(d => d);
          if (datasInicio.length > 0 && !dataInicio) dataInicio = new Date(Math.min(...datasInicio));
          if (datasEntrega.length > 0 && !dataFim) dataFim = new Date(Math.max(...datasEntrega));
          if (progresso === 0 || !progresso) {
            const finalizados = itensDoEpico.filter(i => i.momento && String(i.momento).toUpperCase().includes('FINALIZADO')).length;
            if (itensDoEpico.length > 0) progresso = Math.round((finalizados / itensDoEpico.length) * 100);
          }
          const todosFinalizado = itensDoEpico.every(i => i.momento && String(i.momento).toUpperCase().includes('FINALIZADO'));
          const temEmAndamento = itensDoEpico.some(i => i.momento && String(i.momento).toUpperCase().includes('EM ANDAMENTO'));
          if (todosFinalizado) status = 'Conclu√≠do';
          else if (temEmAndamento) status = 'Em andamento';
          else if (!status) status = 'Aguardando';
        }
        if (!dataInicio || !dataFim) data.warnings.push('√âpico "' + epico.nome + '" sem datas definidas');

        let statusMapeado = status;
        const statusUpper = String(status).toUpperCase();
        if (statusUpper.includes('EMANDAMENTO') || statusUpper === 'EM ANDAMENTO') statusMapeado = 'Em andamento';
        else if (statusUpper.includes('BACKLOG')) statusMapeado = 'Aguardando';
        else if (statusUpper.includes('FINALIZADO')) statusMapeado = 'Conclu√≠do';

        const historias = itensDoEpico.filter(item => {
          const tipo = item.tipo ? String(item.tipo).toLowerCase().trim() : '';
          return tipo === 'historia' || tipo === 'hist√≥ria';
        }).map(h => {
          const statusHistoria = mapStatusFromMomento(h.momento);
          let progressoHistoria = 0;
          if (statusHistoria === 'Conclu√≠do') progressoHistoria = 100;
          else if (statusHistoria === 'Em andamento') progressoHistoria = 50;
          return { nome: h.item || '', status: statusHistoria, dataInicio: h.dataInicio, dataFim: h.dataPrevista || h.dataEntrega, progresso: progressoHistoria };
        }).filter(h => h.dataInicio || h.dataFim);

        data.processos.push({ id: 'E' + (index + 1), nome: epico.nome, status: statusMapeado, dataInicio: dataInicio, dataFim: dataFim, progresso: progresso, ordem: index + 1, historias: historias });
      });

      data.epicos.forEach((epico, index) => {
        if (epico.progresso >= 100 || String(epico.status).toUpperCase().includes('FINALIZADO')) {
          const itensDoEpico = data.itens.filter(item => item.epico && item.epico.includes(epico.nomeOriginal));
          let dataMarco = epico.dataFim;
          if (!dataMarco && itensDoEpico.length > 0) {
            const datasEntrega = itensDoEpico.map(i => i.dataEntrega || i.dataPrevista).filter(d => d).map(d => toDate(d)).filter(d => d);
            if (datasEntrega.length > 0) dataMarco = new Date(Math.max(...datasEntrega));
          }
          if (dataMarco) data.marcos.push({ data: dataMarco, marco: 'Conclus√£o: ' + epico.nome, status: 'Conclu√≠do', cor: 'verde', ordem: index + 1 });
        }
      });

      data.itens.filter(item => item.momento && String(item.momento).toUpperCase().includes('BLOQUEADO')).forEach((item, index) => {
        data.riscos.push({ risco: 'Bloqueio: ' + item.item, descricao: 'Item ' + item.id + ' est√° bloqueado. √âpico: ' + (item.epico || 'N/A'), impacto: 'Alto', severidade: 'Cr√≠tica', ordem: index + 1 });
      });

      data.itens.filter(item => item.momento && String(item.momento).toUpperCase().includes('EM ANDAMENTO')).forEach((item, index) => {
        data.proximos.push({ atividade: item.item, data: item.dataPrevista || item.dataEntrega || '', responsavel: item.responsavel || 'A definir', ordem: index + 1 });
      });
    }

    function applyMeta(meta) {
      const nameEl = document.getElementById('project-name');
      if (nameEl && meta.NomeProjeto) nameEl.textContent = meta.NomeProjeto;
      const descEl = document.getElementById('project-description-text');
      if (descEl && meta.DescricaoProjeto) descEl.textContent = meta.DescricaoProjeto;
      const startEl = document.getElementById('project-start-date');
      if (startEl && meta.DataInicio) startEl.textContent = formatDate(meta.DataInicio);
      const endEl = document.getElementById('project-end-date');
      if (endEl && meta.DataFimPrevista) endEl.textContent = formatDate(meta.DataFimPrevista);
      const statusTextEl = document.getElementById('status-geral-text');
      if (statusTextEl && meta.StatusGeral) statusTextEl.textContent = 'Status Geral: ' + meta.StatusGeral;
      const dotEl = document.getElementById('status-geral-dot');
      if (dotEl && meta.CorStatusGeral) {
        const colorClass = mapColorClass(meta.CorStatusGeral);
        if (colorClass === 'red') dotEl.style.background = 'var(--red)';
        else if (colorClass === 'yellow') dotEl.style.background = 'var(--yellow)';
        else dotEl.style.background = 'var(--green)';
      }
      const percEl = document.getElementById('project-progress-percent');
      const progressBar = document.getElementById('progress');
      if (meta.ProgressoGeralPercentual !== undefined && meta.ProgressoGeralPercentual !== null) {
        const val = Number(meta.ProgressoGeralPercentual) || 0;
        if (percEl) percEl.textContent = val + '%';
        if (progressBar) setTimeout(() => { progressBar.style.width = val + '%'; }, 100);
      }
    }

    function showWarnings(warnings) {
      const alertDiv = document.getElementById('validation-alerts');
      if (!alertDiv) return;
      alertDiv.innerHTML = '';
      if (warnings && warnings.length > 0) {
        const alert = document.createElement('div');
        alert.className = 'alert-box';
        alert.innerHTML = '<strong>‚ö†Ô∏è Aten√ß√µes:</strong>';
        const ul = document.createElement('ul');
        ul.style.marginTop = '8px';
        warnings.forEach(w => { const li = document.createElement('li'); li.textContent = w; li.style.marginBottom = '4px'; ul.appendChild(li); });
        alert.appendChild(ul);
        alertDiv.appendChild(alert);
      }
    }

    // CORRE√á√ÉO 2: Fun√ß√µes para expandir/colapsar todos
    function expandAllGantt() {
      const grid = document.getElementById('gantt-grid');
      if (!grid) return;
      grid.querySelectorAll('.historia-row').forEach(row => row.classList.add('expanded'));
      grid.querySelectorAll('.expand-toggle.has-historias').forEach(btn => btn.textContent = '‚ñº');
    }

    function collapseAllGantt() {
      const grid = document.getElementById('gantt-grid');
      if (!grid) return;
      grid.querySelectorAll('.historia-row').forEach(row => row.classList.remove('expanded'));
      grid.querySelectorAll('.expand-toggle.has-historias').forEach(btn => btn.textContent = '‚ñ∂');
    }

    function renderGantt(processos) {
      const grid = document.getElementById('gantt-grid');
      const headerMonths = document.getElementById('gantt-header-months');
      if (!grid || !processos || !processos.length) { if (grid) grid.innerHTML = '<div style="padding: 20px; text-align: center; color: #6b778c;">Nenhum processo dispon√≠vel</div>'; return; }
      
      let minStart = null, maxEnd = null;
      const allItems = [...processos];
      processos.forEach(p => { if (p.historias && p.historias.length > 0) allItems.push(...p.historias); });
      allItems.forEach(p => {
        const s = toDate(p.dataInicio), e = toDate(p.dataFim);
        if (!s || !e) return;
        if (!minStart || s < minStart) minStart = s;
        if (!maxEnd || e > maxEnd) maxEnd = e;
      });
      if (!minStart || !maxEnd) { grid.innerHTML = '<div style="padding: 20px; text-align: center; color: #6b778c;">Processos sem datas v√°lidas</div>'; return; }
      const totalMs = maxEnd - minStart;
      if (totalMs <= 0) return;

      if (headerMonths) {
        headerMonths.innerHTML = '';
        let d = new Date(minStart.getFullYear(), minStart.getMonth(), 1);
        const endMonth = new Date(maxEnd.getFullYear(), maxEnd.getMonth(), 1);
        while (d <= endMonth) {
          const div = document.createElement('div');
          div.className = 'gantt-header-month';
          div.textContent = d.toLocaleDateString('pt-BR', { month: 'short' }).replace('.', '').toUpperCase() + '/' + d.getFullYear().toString().slice(-2);
          headerMonths.appendChild(div);
          d.setMonth(d.getMonth() + 1);
        }
      }

      grid.innerHTML = '';
      processos.forEach(p => {
        renderGanttRow(p, minStart, totalMs, grid, false);
        if (p.historias && p.historias.length > 0) p.historias.forEach(h => renderGanttRow(h, minStart, totalMs, grid, true, p.id));
      });

      const printBody = document.getElementById('gantt-print-body');
      if (printBody) {
        printBody.innerHTML = '';
        processos.forEach(p => {
          const tr = document.createElement('tr');
          tr.innerHTML = '<td><strong>' + (p.nome || '') + '</strong></td><td>' + formatDate(p.dataInicio) + ' ‚Äì ' + formatDate(p.dataFim) + '</td><td>' + (p.status || '') + '</td><td>' + (p.progresso != null ? p.progresso + '%' : '') + '</td>';
          printBody.appendChild(tr);
          if (p.historias && p.historias.length > 0) p.historias.forEach(h => {
            const htr = document.createElement('tr');
            htr.innerHTML = '<td style="padding-left: 20px;">‚îî ' + (h.nome || '') + '</td><td>' + formatDate(h.dataInicio) + ' ‚Äì ' + formatDate(h.dataFim) + '</td><td>' + (h.status || '') + '</td><td>' + (h.progresso != null ? h.progresso + '%' : '') + '</td>';
            printBody.appendChild(htr);
          });
        });
      }
    }

    function renderGanttRow(item, minStart, totalMs, container, isHistoria, epicoId) {
      const s = toDate(item.dataInicio), e = toDate(item.dataFim);
      if (!s || !e) return;
      const startPercent = ((s - minStart) / totalMs) * 100;
      const endPercent = ((e - minStart) / totalMs) * 100;
      let left = Math.max(0, Math.min(100, startPercent));
      let right = Math.max(0, Math.min(100, endPercent));
      if (right < left) right = left;
      let width = right - left;
      if (width < 5) { width = 5; if (left + width > 100) left = Math.max(0, 100 - width); }
      if (left + width > 100) width = 100 - left;
      const statusClass = mapStatusChipClass(item.status);

      const row = document.createElement('div');
      row.className = 'gantt-row' + (isHistoria ? ' historia-row' : '');
      if (isHistoria && epicoId) row.setAttribute('data-epico-id', epicoId);

      const leftDiv = document.createElement('div');
      leftDiv.className = 'gantt-row-left';
      const titleDiv = document.createElement('div');
      titleDiv.className = 'process-title';

      if (!isHistoria && item.historias && item.historias.length > 0) {
        const toggleBtn = document.createElement('span');
        toggleBtn.className = 'expand-toggle has-historias';
        toggleBtn.textContent = '‚ñ∂';
        toggleBtn.setAttribute('data-epico-id', item.id);
        toggleBtn.addEventListener('click', function(ev) {
          ev.stopPropagation();
          const eid = this.getAttribute('data-epico-id');
          const hrows = container.querySelectorAll('.historia-row[data-epico-id="' + eid + '"]');
          if (this.textContent === '‚ñº') { this.textContent = '‚ñ∂'; hrows.forEach(r => r.classList.remove('expanded')); }
          else { this.textContent = '‚ñº'; hrows.forEach(r => r.classList.add('expanded')); }
        });
        titleDiv.appendChild(toggleBtn);
      }
      const nameSpan = document.createElement('span');
      nameSpan.textContent = item.nome || '';
      titleDiv.appendChild(nameSpan);
      if (!isHistoria && item.historias && item.historias.length > 0) {
        const countSpan = document.createElement('span');
        countSpan.className = 'historia-count';
        countSpan.textContent = item.historias.length + ' hist√≥ria' + (item.historias.length > 1 ? 's' : '');
        titleDiv.appendChild(countSpan);
      }
      leftDiv.appendChild(titleDiv);

      const statusSpan = document.createElement('span');
      statusSpan.className = 'status-chip ' + statusClass;
      statusSpan.textContent = item.status || '';
      leftDiv.appendChild(statusSpan);

      const dateSpan = document.createElement('span');
      dateSpan.className = 'process-date';
      dateSpan.textContent = (formatDate(item.dataInicio) || '') + ' ‚Äì ' + (formatDate(item.dataFim) || '');
      leftDiv.appendChild(dateSpan);

      const rightDiv = document.createElement('div');
      rightDiv.className = 'gantt-row-right';
      const laneDiv = document.createElement('div');
      laneDiv.className = 'gantt-lane';
      const barDiv = document.createElement('div');
      barDiv.className = 'gantt-bar ' + statusClass;
      barDiv.style.left = left + '%';
      barDiv.style.width = width + '%';
      barDiv.textContent = item.progresso != null ? item.progresso + '%' : '';
      laneDiv.appendChild(barDiv);
      rightDiv.appendChild(laneDiv);

      row.appendChild(leftDiv);
      row.appendChild(rightDiv);
      container.appendChild(row);
    }

    function renderMarcos(marcos) {
      const tbody = document.getElementById('marcos-body');
      if (!tbody) return;
      if (!marcos || !marcos.length) { tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #6b778c;">Nenhum marco dispon√≠vel</td></tr>'; return; }
      tbody.innerHTML = '';
      marcos.forEach(m => {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td><strong>' + (formatDate(m.data) || '') + '</strong></td><td>' + (m.marco || '') + '</td><td><span class="badge ' + mapColorClass(m.cor) + '"><span class="status-dot"></span> ' + (m.status || '') + '</span></td>';
        tbody.appendChild(tr);
      });
    }

    function renderRiscos(riscos) {
      const ul = document.getElementById('risk-list');
      if (!ul) return;
      if (!riscos || !riscos.length) { ul.innerHTML = '<li>Nenhum risco identificado</li>'; return; }
      ul.innerHTML = '';
      riscos.forEach(r => {
        const li = document.createElement('li');
        let texto = r.risco ? '<strong>' + r.risco + '</strong>' : '';
        if (r.descricao) texto += (texto ? ' ‚Äì ' : '') + r.descricao;
        const extras = [];
        if (r.impacto) extras.push('Impacto ' + r.impacto);
        if (r.severidade) extras.push('Severidade ' + r.severidade);
        if (extras.length) texto += ' (' + extras.join(', ') + ')';
        li.innerHTML = texto;
        ul.appendChild(li);
      });
    }

    function renderNextSteps(steps) {
      const tbody = document.getElementById('next-steps-body');
      if (!tbody) return;
      if (!steps || !steps.length) { tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #6b778c;">Nenhum pr√≥ximo passo definido</td></tr>'; return; }
      tbody.innerHTML = '';
      steps.forEach(s => {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td>' + (s.atividade || '') + '</td><td><strong>' + (formatDate(s.data) || '') + '</strong></td><td>' + (s.responsavel || '') + '</td>';
        tbody.appendChild(tr);
      });
    }

    function toISODateInput(value) {
      const d = toDate(value);
      if (!d) return '';
      return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    }

    function populateMetaTab() {
      const tab = document.getElementById('editor-tab-meta');
      if (!tab || !currentData) return;
      tab.innerHTML = '';
      const table = document.createElement('table');
      table.className = 'editor-table';
      const tbody = document.createElement('tbody');
      const fields = [
        { key: 'NomeProjeto', label: 'Nome do Projeto', type: 'text' },
        { key: 'DescricaoProjeto', label: 'Descri√ß√£o do Projeto', type: 'textarea' },
        { key: 'DataInicio', label: 'Data de In√≠cio', type: 'date' },
        { key: 'DataFimPrevista', label: 'Previs√£o de Conclus√£o', type: 'date' },
        { key: 'StatusGeral', label: 'Status Geral', type: 'text' },
        { key: 'CorStatusGeral', label: 'Cor do Status', type: 'text' },
        { key: 'ProgressoGeralPercentual', label: 'Progresso (%)', type: 'number' },
        { key: 'Responsavel', label: 'Respons√°vel', type: 'text' },
        { key: 'Owner', label: 'Owner', type: 'text' }
      ];
      fields.forEach(f => {
        const tr = document.createElement('tr');
        const tdLabel = document.createElement('td');
        tdLabel.textContent = f.label;
        tdLabel.style.width = '40%';
        const tdInput = document.createElement('td');
        if (f.type === 'textarea') {
          const textarea = document.createElement('textarea');
          textarea.setAttribute('data-meta-key', f.key);
          textarea.value = currentData.meta[f.key] != null ? currentData.meta[f.key] : '';
          tdInput.appendChild(textarea);
        } else {
          const input = document.createElement('input');
          input.setAttribute('data-meta-key', f.key);
          input.type = f.type || 'text';
          if (f.type === 'number') { input.min = '0'; input.max = '100'; }
          input.value = f.type === 'date' ? toISODateInput(currentData.meta[f.key]) : (currentData.meta[f.key] != null ? currentData.meta[f.key] : '');
          tdInput.appendChild(input);
        }
        tr.appendChild(tdLabel);
        tr.appendChild(tdInput);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      tab.appendChild(table);
    }

    function createTableRow(fields, data) {
      const tr = document.createElement('tr');
      fields.forEach(cfg => {
        const td = document.createElement('td');
        const input = document.createElement('input');
        input.type = cfg.type;
        input.setAttribute('data-field', cfg.field);
        let val = data ? data[cfg.field] : '';
        input.value = cfg.type === 'date' ? toISODateInput(val) : (val != null ? val : '');
        td.appendChild(input);
        tr.appendChild(td);
      });
      const tdActions = document.createElement('td');
      const delBtn = document.createElement('button');
      delBtn.type = 'button';
      delBtn.className = 'row-delete-btn';
      delBtn.textContent = 'Excluir';
      tdActions.appendChild(delBtn);
      tr.appendChild(tdActions);
      return tr;
    }

    function populateProcessosTab() {
      const tab = document.getElementById('editor-tab-processos');
      if (!tab || !currentData) return;
      tab.innerHTML = '';
      const table = document.createElement('table');
      table.className = 'editor-table';
      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      ['ID', 'Processo', 'Status', 'Data In√≠cio', 'Data Fim', '%', 'Ordem', ''].forEach(t => { const th = document.createElement('th'); th.textContent = t; headRow.appendChild(th); });
      thead.appendChild(headRow);
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      const fields = [{ field: 'id', type: 'text' }, { field: 'nome', type: 'text' }, { field: 'status', type: 'text' }, { field: 'dataInicio', type: 'date' }, { field: 'dataFim', type: 'date' }, { field: 'progresso', type: 'number' }, { field: 'ordem', type: 'number' }];
      (currentData.processos || []).forEach(p => tbody.appendChild(createTableRow(fields, p)));
      table.appendChild(tbody);
      tab.appendChild(table);
      const addBtn = document.createElement('button');
      addBtn.type = 'button';
      addBtn.className = 'editor-add-btn';
      addBtn.textContent = '+ Adicionar processo';
      addBtn.addEventListener('click', () => tbody.appendChild(createTableRow(fields, {})));
      tab.appendChild(addBtn);
    }

    function populateMarcosTab() {
      const tab = document.getElementById('editor-tab-marcos');
      if (!tab || !currentData) return;
      tab.innerHTML = '';
      const table = document.createElement('table');
      table.className = 'editor-table';
      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      ['Data', 'Marco', 'Status', 'Cor', 'Ordem', ''].forEach(t => { const th = document.createElement('th'); th.textContent = t; headRow.appendChild(th); });
      thead.appendChild(headRow);
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      const fields = [{ field: 'data', type: 'date' }, { field: 'marco', type: 'text' }, { field: 'status', type: 'text' }, { field: 'cor', type: 'text' }, { field: 'ordem', type: 'number' }];
      (currentData.marcos || []).forEach(m => tbody.appendChild(createTableRow(fields, m)));
      table.appendChild(tbody);
      tab.appendChild(table);
      const addBtn = document.createElement('button');
      addBtn.type = 'button';
      addBtn.className = 'editor-add-btn';
      addBtn.textContent = '+ Adicionar marco';
      addBtn.addEventListener('click', () => tbody.appendChild(createTableRow(fields, {})));
      tab.appendChild(addBtn);
    }

    function populateRiscosTab() {
      const tab = document.getElementById('editor-tab-riscos');
      if (!tab || !currentData) return;
      tab.innerHTML = '';
      const table = document.createElement('table');
      table.className = 'editor-table';
      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      ['Risco', 'Descri√ß√£o', 'Impacto', 'Severidade', 'Ordem', ''].forEach(t => { const th = document.createElement('th'); th.textContent = t; headRow.appendChild(th); });
      thead.appendChild(headRow);
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      const fields = [{ field: 'risco', type: 'text' }, { field: 'descricao', type: 'text' }, { field: 'impacto', type: 'text' }, { field: 'severidade', type: 'text' }, { field: 'ordem', type: 'number' }];
      (currentData.riscos || []).forEach(r => tbody.appendChild(createTableRow(fields, r)));
      table.appendChild(tbody);
      tab.appendChild(table);
      const addBtn = document.createElement('button');
      addBtn.type = 'button';
      addBtn.className = 'editor-add-btn';
      addBtn.textContent = '+ Adicionar risco';
      addBtn.addEventListener('click', () => tbody.appendChild(createTableRow(fields, {})));
      tab.appendChild(addBtn);
    }

    function populateProximosTab() {
      const tab = document.getElementById('editor-tab-proximos');
      if (!tab || !currentData) return;
      tab.innerHTML = '';
      const table = document.createElement('table');
      table.className = 'editor-table';
      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      ['Atividade', 'Data prevista', 'Respons√°vel', 'Ordem', ''].forEach(t => { const th = document.createElement('th'); th.textContent = t; headRow.appendChild(th); });
      thead.appendChild(headRow);
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      const fields = [{ field: 'atividade', type: 'text' }, { field: 'data', type: 'date' }, { field: 'responsavel', type: 'text' }, { field: 'ordem', type: 'number' }];
      (currentData.proximos || []).forEach(p => tbody.appendChild(createTableRow(fields, p)));
      table.appendChild(tbody);
      tab.appendChild(table);
      const addBtn = document.createElement('button');
      addBtn.type = 'button';
      addBtn.className = 'editor-add-btn';
      addBtn.textContent = '+ Adicionar pr√≥ximo passo';
      addBtn.addEventListener('click', () => tbody.appendChild(createTableRow(fields, {})));
      tab.appendChild(addBtn);
    }

    function openEditor() {
      if (!currentData) { alert('Para editar, primeiro carregue a planilha do projeto.'); return; }
      populateMetaTab();
      populateProcessosTab();
      populateMarcosTab();
      populateRiscosTab();
      populateProximosTab();
      document.getElementById('editor-modal').style.display = 'flex';
      setActiveEditorTab('meta');
    }

    function closeEditor() { document.getElementById('editor-modal').style.display = 'none'; }

    function setActiveEditorTab(tabName) {
      const modal = document.getElementById('editor-modal');
      modal.querySelectorAll('.editor-tabs button').forEach(btn => btn.classList.toggle('active', btn.getAttribute('data-tab') === tabName));
      modal.querySelectorAll('.editor-tab').forEach(div => div.classList.toggle('active', div.getAttribute('data-tab') === tabName));
    }

    function readEditorDataAndSave() {
      if (!currentData) return;
      document.querySelectorAll('#editor-tab-meta [data-meta-key]').forEach(input => {
        const key = input.getAttribute('data-meta-key');
        currentData.meta[key] = key === 'ProgressoGeralPercentual' ? (Number(input.value) || 0) : input.value;
      });
      
      ['processos', 'marcos', 'riscos', 'proximos'].forEach(section => {
        const tab = document.getElementById('editor-tab-' + section);
        if (!tab) return;
        const tbody = tab.querySelector('tbody');
        const rows = tbody ? Array.from(tbody.querySelectorAll('tr')) : [];
        const novos = [];
        rows.forEach(row => {
          const getVal = (field) => { const inp = row.querySelector('input[data-field="' + field + '"]'); return inp ? inp.value : ''; };
          const obj = {};
          row.querySelectorAll('input[data-field]').forEach(inp => {
            const field = inp.getAttribute('data-field');
            obj[field] = inp.type === 'number' ? (inp.value.trim() ? Number(inp.value) || 0 : null) : inp.value.trim();
          });
          const mainField = section === 'processos' ? 'nome' : section === 'marcos' ? 'marco' : section === 'riscos' ? 'risco' : 'atividade';
          if (obj[mainField]) novos.push(obj);
        });
        currentData[section] = novos;
      });

      applyMeta(currentData.meta);
      renderGantt(currentData.processos);
      renderMarcos(currentData.marcos);
      renderRiscos(currentData.riscos);
      renderNextSteps(currentData.proximos);
      alert('‚úÖ Altera√ß√µes salvas!');
    }

    (function initExcelImport() {
      const btn = document.getElementById('update-button');
      const input = document.getElementById('excel-file');
      if (!btn || !input) return;
      btn.addEventListener('click', () => input.click());
      input.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array', cellDates: true });
            const parsed = parseSistemaExcel(workbook);
            currentData = parsed;
            showWarnings(parsed.warnings);
            applyMeta(parsed.meta);
            renderGantt(parsed.processos);
            renderMarcos(parsed.marcos);
            renderRiscos(parsed.riscos);
            renderNextSteps(parsed.proximos);
          } catch (error) { alert('Erro: ' + error.message); console.error(error); }
        };
        reader.readAsArrayBuffer(file);
        event.target.value = '';
      });
    })();

    (function initEditorUI() {
      const expandAllBtn = document.getElementById('btn-expand-all');
      const collapseAllBtn = document.getElementById('btn-collapse-all');
      if (expandAllBtn) expandAllBtn.addEventListener('click', expandAllGantt);
      if (collapseAllBtn) collapseAllBtn.addEventListener('click', collapseAllGantt);
      
      document.getElementById('edit-button').addEventListener('click', openEditor);
      document.getElementById('editor-close').addEventListener('click', closeEditor);
      document.getElementById('editor-cancel').addEventListener('click', closeEditor);
      document.getElementById('editor-save').addEventListener('click', () => { readEditorDataAndSave(); closeEditor(); });
      
      const modal = document.getElementById('editor-modal');
      modal.querySelectorAll('.editor-tabs button').forEach(btn => btn.addEventListener('click', () => setActiveEditorTab(btn.getAttribute('data-tab'))));
      modal.addEventListener('click', function(e) {
        if (e.target.classList.contains('row-delete-btn') && confirm('Excluir esta linha?')) e.target.closest('tr').remove();
        if (e.target === modal) closeEditor();
      });
    })();

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && document.getElementById('editor-modal').style.display === 'flex') closeEditor();
    });
  </script>
</body>
</html>
